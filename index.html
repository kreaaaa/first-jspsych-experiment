<!DOCTYPE html>
<html>
    <head>
        <title> my experiment </title>
        <script src="https://unpkg.com/jspsych@7.3.4"></script>
        <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.0.0"></script>
        <link href="https://unpkg.com/jspsych@8.0.0/css/jspsych.css" rel="stylesheet" type="text/css">
        <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.3"></script>
        <script src= "jspsych/modified-image-plugin.js"></script>
        <script src= "all_sentences.js"></script>
        <script src= "association.js"></script>
        <script src= "priming.js"></script>
        <script src="https://unpkg.com/@jspsych/plugin-instructions@1.1.4"></script>
    
        
</head>
<body>

</body>
<script>
    const jsPsych = initJsPsych(

{
    on_finish: function(data) {
        jsPsych.data.displayData();
    }
}
);

//generate random ID

var id = Math.floor(Math.random() * 1000000000);
console.log("id=", id)

//tag all trials with ID

jsPsych.data.addProperties({
    ID: id
});

var random_attention_trials = jsPsych.randomization.sampleWithoutReplacement([...Array(35).keys()].map(x => x+5),3);

console.log("random_attention_trials= " + random_attention_trials);
//can check the trial numbers w command option I and console

var initial_instructions = {
    type: jsPsychInstructions,
    pages: [
    'page 1 instructions.',
    'page 2 instructions.',
    'page 3 instructions.'
    ],
    show_clickable_nav: true,
    data: { 
        typeoftrial: 'instructions',
    },
}

var sentence_number = 0 ;

var sentence = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: jsPsych.timelineVariable('sentence'),
    choices: [' '],
    trial_duration: 100,
    on_finish: function(data) {
        last_trial_index = (data.trial_index + 1 ) % 40 ;
        console.log ("last_trial_index = " + last_trial_index);
        sentence_number = (sentence_number + 1 ) % 40;
       console.log ("sentence_number = " + sentence_number);
    },
data: {
        typeoftrial: 'sentence',
        sentence: jsPsych.timelineVariable('sentence'),
        novel1: jsPsych.timelineVariable('novel1'),
        novel2: jsPsych.timelineVariable('novel2'),
        novel3: jsPsych.timelineVariable('novel3')
    },
}
//string sentences mapping onto string of the sentences

var attention = {
    type: jsPsychSurveyText,
    questions: [{prompt: "Type any ONE novel word from the previous sentence:"}],
//two forward slashes to take notes
    data: {
        typeoftrial: 'attention',
    },

    on_finish: function (data){
        var last_trial_data = jsPsych.data.get().filter({typeoftrial: 'sentence'}). last(1).values()[0];
    console.log("last_trial_data= ", last_trial_data);

    data.novel1= last_trial_data.novel1;
    data.novel2= last_trial_data.novel2;
    data.novel3= last_trial_data.novel3;
    data.response = data.response.Q0;

    if(
        jsPsych.pluginAPI.compareKeys(data.response, data.novel1) ||
        jsPsych.pluginAPI.compareKeys(data.response, data.novel2) ||
        jsPsych.pluginAPI.compareKeys(data.response, data.novel3) 
    ){
        data.correct = 1;
        console.log("correct=" + data.correct);
    } else {
        data.correct = 0;
        console.log("correct=" + data.correct);}
}
}

var attention_conditional = {
    timeline: [attention],
    conditional_function: function () {
        if(random_attention_trials.includes(sentence_number)){return true;} 
        else {return false;}
    }
}

var association_instructions = {
    type: jsPsychInstructions,
    pages: [
    'Done with sentences. Association time.'
    ],
    show_clickable_nav: true,
    data: {
        typeoftrial: 'instructions',
    },
}

var association = {
    type: jsPsychSurveyText,
    questions: [{prompt: jsPsych.timelineVariable('cue')}],
    trial_duration: 10,
    data: {
        typeoftrial: 'association',
        cue: jsPsych.timelineVariable('cue')
    },
    on_finish: function(data){
        data.response = data.response.Q0
    },
};

var priming_instructions = {
    type: jsPsychInstructions,
    pages: [
    'Priming task about to begin.'
    ],
    show_clickable_nav: true,
    data: {
        typeoftrial: 'instructions',
    },
}

var slow_experiment_trial = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: "<b> Speed up kiddo</b>! <br><br> Please please please respond faster.",
    choices: "NO_KEYS",
    trial_duration: 1000,
}

var fixation = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: "+",
    choices : "NO_KEYS",
    trial_duration: 500 ,
    data: {
        typeoftrial: 'fixation'
    },
    //NO_KEYS is js psych specific and will not let the participant move on by pressing keys
}

var image = {
    type: jsPsychImageKeyboardResponse,
    stimulus: jsPsych.timelineVariable('image_path'),
    choices : "NO_KEYS",
    trial_duration: 500,
      stimulus_width: 500,
      maintain_aspect_ratio: true,
      prompt: "<span style= 'font-size:200%'><br><br></span>"
    }

var prime = {
    type: jsPsychImageKeyboardResponse,
    stimulus: jsPsych.timelineVariable('image_path'),
    //trial_duration: 300
    choices : "NO_KEYS",
    trial_duration: 500 ,
      stimulus_width: 500 ,
      maintain_aspect_ratio: true,
      prompt: function (){
        return "<span style = 'font-size:200%'><br>" + String(jsPsych.timelineVariable('prime_word'))+"<br></span>";
      },
}

var target = {
    type: jsPsychImageKeyboardResponse,
    stimulus: jsPsych.timelineVariable('image_path'),
    //trial_duration: 300
    choices : ['A', 'L'],
      stimulus_width: 500 ,
      maintain_aspect_ratio: true,
      prompt:  function (){
        return "<span style= 'font-size:200%'><br>" + String(jsPsych.timelineVariable('target_word'))+"<br></span>";
    },
    data: {
        typeoftrial: 'target',
        target: jsPsych.timelineVariable('target_word'), 
        prime: jsPsych.timelineVariable('prime_word'),
        type: jsPsych.timelineVariable ('type'),
        relatedness: jsPsych.timelineVariable('relatedness'),
        correct_key: jsPsych.timelineVariable('correct_key'),
 },

on_finish: function(data){
    data.correct= jsPsych.pluginAPI.compareKeys(data.response, data.correct_key);
}
}


var priming_feedback = {
    timeline: [slow_experiment_trial],
    conditional_function: function(){
        //get the data from previous trial
        //and check if rt is 800 ms
        var rt = jsPsych.data.get().last(1).values()[0].rt;
        if (rt > 800) {
            return true;
        } else {
            return false;
        };
        data: {
        typeoftrial: 'fixation'
    }
}
}


var priming_procedure = {
    timeline: [fixation, image, prime, target, priming_feedback],
    timeline_variables : practice_stimuli,
    randomize_order: true
}

var training_procedure = {
    timeline: [sentence, attention_conditional],
    timeline_variables: sentences,
    randomize_order: true
}


var association_procedure = {
    timeline: [association],
    timeline_variables: association_cues,
    randomize_order: true,
    repetitions: 3
}

var training_plus_association = {
    timeline: [ training_procedure, association_instructions, association_procedure],
    repetitions: 3
}

//jsPsych.run([initial_instructions, training_plus_association, priming_instructions, priming_procedure]);
jsPsych.run([training_procedure])
//jsPsych.run([training_plus_association])
//jsPsych.run([treaining_procedure])

  </script>
</html>